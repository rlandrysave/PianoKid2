<!-- index.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PianoKid Evo Pro - Traduction de Partitions</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- OpenSheetMusicDisplay pour la traduction de partitions -->
    <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js"></script>
</head>
<body>

    <div id="main-menu">
        <div class="profile-bar">
            <div class="profile-left">
                <button onclick="openProfileModal()" class="profile-trigger">
                    üë§ <span id="display-username">Apprenti</span>
                </button>
                <button onclick="toggleColorMode()" id="color-mode-btn">üé® Debutant</button>
                <button onclick="toggleFullScreen()" id="fs-btn">üñ•Ô∏è</button>
            </div>
            <button id="mic-toggle">üé§ Micro OFF</button>
        </div>

        <div class="logo">PianoKid Evo</div>
        
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('cours')">COURS</button>
            <button class="tab-btn" onclick="switchTab('exercices')">EXERCICES</button>
            <button class="tab-btn" onclick="switchTab('apprentissage')">APPRENTISSAGE</button>
            <button class="tab-btn" onclick="switchTab('musique')">MUSIQUES</button>
            <button class="tab-btn" onclick="switchTab('partitions')">üìÅ PARTITIONS</button>
        </div>

        <div id="content-grid" class="grid"></div>
    </div>

    <div id="game-container" style="display:none;">
        <div id="progress-container"><div id="progress-inner"></div></div>
        <button class="btn-close" onclick="quitGame()">‚ùå QUITTER</button>
        
        <!-- Zone d'affichage de la partition OSMD -->
        <div id="score-viewer-container" style="display:none; background:#fff; height:150px; overflow:auto; border-bottom:3px solid var(--accent);">
            <div id="osmd-container"></div>
        </div>

        <div class="speed-controls">
            <button onclick="setSpeed(2)">Lentüê¢</button>
            <button onclick="setSpeed(4)">Normalüö∂</button>
            <button onclick="setSpeed(7)">Rapide‚ö°</button>
        </div>

        <div id="game-layout">
            <div class="finger-guide-side left">
                <div class="hand-flat left-hand">
                    <div class="finger-flat pinky" data-f="5">5</div>
                    <div class="finger-flat ring" data-f="4">4</div>
                    <div class="finger-flat middle" data-f="3">3</div>
                    <div class="finger-flat index" data-f="2">2</div>
                    <div class="finger-flat thumb" data-f="1">1</div>
                    <div class="palm-flat"></div>
                </div>
            </div>
            
            <div id="fall-zone">
                <div id="hit-line"></div>
            </div>

            <div class="finger-guide-side right">
                <div class="hand-flat right-hand">
                    <div class="finger-flat thumb" data-f="1">1</div>
                    <div class="finger-flat index" data-f="2">2</div>
                    <div class="finger-flat middle" data-f="3">3</div>
                    <div class="finger-flat ring" data-f="4">4</div>
                    <div class="finger-flat pinky" data-f="5">5</div>
                    <div class="palm-flat"></div>
                </div>
            </div>
        </div>

        <div id="piano-container">
            <div id="piano"></div>
        </div>
    </div>

    <!-- Modal pour l'upload de partitions -->
    <div id="partition-modal" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <h3>üéº Importer une Partition</h3>
            <p style="color:#888; font-size:0.85rem; margin:10px 0;">
                Formats support√©s : MusicXML (.musicxml, .xml, .mxl) ou MIDI (.mid, .midi) depuis MuseScore
            </p>
            <div style="margin:20px 0; text-align:center;">
                <input type="file" id="partition-file-input" accept=".musicxml,.xml,.mxl,.mid,.midi" style="display:none;">
                <button onclick="document.getElementById('partition-file-input').click()" class="tab-btn" style="width:100%; margin-bottom:10px;">
                    üìÅ Choisir un fichier
                </button>
                <div id="selected-file-name" style="color:#888; font-size:0.9rem; margin:10px 0;"></div>
            </div>
            
            <div style="margin:20px 0;">
                <label style="display:block; margin-bottom:10px; color:var(--accent);">Difficult√© d'adaptation:</label>
                <div class="difficulty-selector">
                    <button class="diff-btn active" onclick="setImportDifficulty('normal', this)">Normal</button>
                    <button class="diff-btn" onclick="setImportDifficulty('facile', this)">Facile</button>
                    <button class="diff-btn" onclick="setImportDifficulty('expert', this)">Expert</button>
                </div>
            </div>

            <div style="margin:20px 0;">
                <label style="display:block; margin-bottom:10px; color:var(--accent);">Transposition:</label>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button onclick="transposeImport(-1)" class="tab-btn">-1</button>
                    <span id="transpose-value" style="line-height:40px; min-width:30px;">0</span>
                    <button onclick="transposeImport(1)" class="tab-btn">+1</button>
                </div>
            </div>

            <button onclick="loadPartitionFile()" class="tab-btn active" style="width:100%; margin-top:20px; background:var(--accent); color:#000;">
                ‚ñ∂ JOUER LA PARTITION
            </button>
            
            <button onclick="closePartitionModal()" class="tab-btn" style="width:100%; margin-top:10px; border-color:#ff4b2b; color:#ff4b2b;">
                ‚ùå ANNULER
            </button>
        </div>
    </div>

    <!-- Modal Profil -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h3>Mes Profils</h3>
            <div id="profiles-list"></div>
            <div class="add-profile-box" style="display:flex; flex-direction:column; gap:15px; margin-top:20px;">
                <input type="text" id="input-username" placeholder="Ton pr√©nom..." style="width:100%; box-sizing:border-box;">
                <div id="emoji-picker"></div>
                <div style="display:flex; gap:10px; margin:15px 0;">
                    <button id="role-enfant" class="role-btn tab-btn active" onclick="setRole('enfant')">üßí Enfant</button>
                    <button id="role-adulte" class="role-btn tab-btn" onclick="setRole('adulte')">üë§ Adulte</button>
                </div>
                <button onclick="createNewProfile()" class="tab-btn active" style="width:100%; background:var(--accent); color:#000; font-weight:bold;">
                    ‚ú® CR√âER LE PROFIL
                </button>
                <button onclick="handleGoogleAuth()" style="background:white; color:#444; border:1px solid #ddd; padding:12px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; margin-top:10px;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
                    Continuer avec Google
                </button>
                <button onclick="handleLogout()" style="background:#ff4444; color:white; border:none; padding:10px; border-radius:8px; width:100%; margin-top:20px; cursor:pointer; font-weight:bold;">
                    Log Out
                </button>
            </div>
            <button onclick="closeProfileModal()" class="tab-btn" style="width:100%; margin-top:10px; border-color:#ff4b2b; color:#ff4b2b;">
                ‚ùå ANNULER
            </button>
        </div>
    </div>

    <!-- Modal Prix -->
    <div id="pricing-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; justify-content:center; align-items:center;">
        <div style="background:#1a1a24; padding:30px; border-radius:20px; border:2px solid var(--accent); text-align:center; max-width:400px; margin:20px;">
            <h2 style="color:var(--accent); margin-top:0;">Passe au niveau PRO ! üöÄ</h2>
            <p style="color:#ccc;">D√©bloque tous les cours, exercices et musiques.</p>
            <div style="font-size:28px; font-weight:bold; margin:20px 0; color:white;">9,90‚Ç¨ <span style="font-size:14px; color:#888;">/ mois</span></div>
            <button onclick="unlockPro()" style="background:var(--accent); color:black; border:none; padding:15px 30px; border-radius:10px; font-weight:bold; cursor:pointer; width:100%;">üí≥ Passer PRO</button>
            <button onclick="closePricing()" style="background:transparent; color:#888; border:none; cursor:pointer; margin-top:15px;">Plus tard</button>
        </div>
    </div>

    <!-- Modal Auth -->
    <div id="auth-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:20000; justify-content:center; align-items:center;">
        <div style="background:#1a1a24; padding:30px; border-radius:20px; border:2px solid #ff4b2b; text-align:center; width:320px;">
            <h2 id="auth-title" style="color:#ff4b2b; margin-bottom:20px;">Connexion üéπ</h2>
            <input type="email" id="auth-email" placeholder="Email" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:none; background:#2a2a3a; color:white;">
            <input type="password" id="auth-password" placeholder="Mot de passe" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px; border:none; background:#2a2a3a; color:white;">
            <button onclick="handleAuth()" id="auth-submit-btn" style="background:#ff4b2b; color:black; border:none; padding:12px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer;">Se connecter</button>
            <div style="margin:20px 0; color:#555; display:flex; align-items:center;">
                <hr style="flex:1; border:0; border-top:1px solid #333;">
                <span style="margin:0 10px; font-size:0.8rem;">OU</span>
                <hr style="flex:1; border:0; border-top:1px solid #333;">
            </div>
            <button onclick="handleGoogleAuth()" style="background:white; color:#444; border:none; padding:12px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
                Continuer avec Google
            </button>
            <p style="color:#888; font-size:0.8rem; margin-top:15px;">
                Pas de compte ? <span onclick="toggleAuthMode()" style="color:#ff4b2b; cursor:pointer; text-decoration:underline;">S'inscrire</span>
            </p>
            <button onclick="document.getElementById('auth-modal').style.display='none'" style="background:transparent; color:#555; border:none; margin-top:10px; cursor:pointer;">Annuler</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCmR4_oLkO-Vh4W0D2YgeemXepRt89wjc",
            authDomain: "pianokid-evo.firebaseapp.com",
            projectId: "pianokid-evo",
            storageBucket: "pianokid-evo.firebasestorage.app",
            messagingSenderId: "744883971321",
            appId: "1:744883971321:web:a29d02fce39137e6316e28"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let isSignUpMode = false;

        window.toggleAuthMode = () => {
            isSignUpMode = !isSignUpMode;
            document.getElementById('auth-title').innerText = isSignUpMode ? "Inscription üöÄ" : "Connexion üéπ";
            document.getElementById('auth-submit-btn').innerText = isSignUpMode ? "Cr√©er un compte" : "Se connecter";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            try {
                if (isSignUpMode) {
                    const result = await createUserWithEmailAndPassword(auth, email, password);
                    await createFirestoreUser(result.user);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                document.getElementById('auth-modal').style.display = 'none';
            } catch (e) { alert("Erreur : " + e.message); }
        };

        window.handleGoogleAuth = async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                await createFirestoreUser(result.user);
                document.getElementById('auth-modal').style.display = 'none';
                document.getElementById('partition-modal').style.display = 'none';
            } catch (e) { alert("Erreur Google : " + e.message); }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                location.reload();
            } catch (e) { console.error(e); }
        };

        async function createFirestoreUser(user) {
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);
            if (!snap.exists()) {
                await setDoc(userRef, {
                    email: user.email,
                    isPro: false,
                    createdAt: new Date(),
                    username: user.displayName || user.email.split('@')[0]
                });
            }
        }

        onAuthStateChanged(auth, async (user) => {
            const display = document.getElementById('display-username');
            if (user) {
                display.innerText = (user.displayName || user.email.split('@')[0]);
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    window.isPro = userSnap.data().isPro;
                }
            } else {
                display.innerText = "Invit√©";
                window.isPro = false;
            }
            if (typeof switchTab === 'function') switchTab('cours');
        });
    </script>

    <script src="script.js"></script>
</body>
</html>
